<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç•™è¨€è¯„è®º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", "æ€æºé»‘ä½“", sans-serif;
        }

        html, body {
            height: 100%;
            background-color: #f5f7ff;
            overflow-x: hidden;
            padding-bottom: 70px; /* ç»™åº•éƒ¨æŒ‰é’®ç•™ç©ºé—´ */
        }

        /* é¡¶éƒ¨æ ‡é¢˜æ  */
        .top-bar {
            background: linear-gradient(135deg, #9370DB, #8A2BE2);
            padding: 18px 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(147, 112, 219, 0.3);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .title {
            font-size: 22px;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* ç•™è¨€è¾“å…¥åŒºï¼ˆé€‚é…è§¦æ§ï¼‰ */
        .input-area {
            padding: 20px;
            background-color: #fff;
            margin: 15px;
            border-radius: 12px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.05);
        }

        .username-input {
            width: 100%;
            height: 45px;
            padding: 0 15px;
            border: 2px solid #E6E6FA;
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 16px;
            color: #333;
        }

        .message-input {
            width: 100%;
            height: 120px;
            padding: 15px;
            border: 2px solid #E6E6FA;
            border-radius: 8px;
            resize: none;
            font-size: 16px;
            color: #333;
            line-height: 1.5;
        }

        .submit-btn {
            width: 100%;
            height: 50px;
            background: linear-gradient(135deg, #9370DB, #8A2BE2);
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            margin-top: 12px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(147, 112, 219, 0.3);
            transition: transform 0.2s;
        }

        .submit-btn:active {
            transform: scale(0.98);
        }

        /* ç•™è¨€åˆ—è¡¨åŒº */
        .message-list {
            padding: 0 20px 80px;
            flex: 1;
            overflow-y: auto;
        }

        .list-title {
            font-size: 18px;
            color: #666;
            margin: 15px 0;
            padding-left: 5px;
            border-left: 3px solid #9370DB;
        }

        /* ç•™è¨€å¡ç‰‡ */
        .message-card {
            background-color: #fff;
            padding: 18px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-left: 4px solid #9370DB;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .username {
            font-size: 17px;
            font-weight: bold;
            color: #8A2BE2;
        }

        .time {
            font-size: 14px;
            color: #999;
        }

        .content {
            font-size: 16px;
            color: #333;
            line-height: 1.6;
            white-space: pre-wrap; /* ä¿ç•™æ¢è¡Œ */
        }

        /* ç©ºåˆ—è¡¨æç¤º */
        .empty-tip {
            text-align: center;
            padding: 50px 0;
            color: #999;
            font-size: 16px;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 15px;
            color: #E6E6FA;
        }

        /* åŠ è½½æç¤º */
        .loading-tip {
            text-align: center;
            padding: 30px 0;
            color: #999;
            font-size: 16px;
        }

        /* åº•éƒ¨åŒæŒ‰é’®ï¼ˆåŒ¹é…ä½ æä¾›çš„å›¾ç‰‡é£æ ¼ï¼‰ */
        .bottom-btn-container {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 10px 20px;
            background-color: #fff;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 9;
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
        .bottom-btn {
            width: 48%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        /* é¦–é¡µæŒ‰é’®ï¼ˆå’Œä½ å›¾ç‰‡é‡Œçš„æ ·å¼ä¸€è‡´ï¼‰ */
        .home-btn {
            background: transparent;
            color: #8A2BE2; /* åŒ¹é…é¡µé¢ç´«è‰²é£æ ¼ */
        }
        /* ç•™è¨€æ¿æŒ‰é’®ï¼ˆå½“å‰é¡µæ ‡è¯†æ€ï¼‰ */
        .message-board-btn {
            background: linear-gradient(135deg, #9370DB, #8A2BE2);
            color: #fff;
            pointer-events: none; /* ç¦æ­¢ç‚¹å‡» */
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
    <div class="top-bar">
        <h1 class="title">âœ¨ ç•™è¨€è¯„è®º âœ¨</h1>
    </div>

    <!-- ç•™è¨€è¾“å…¥åŒº -->
    <div class="input-area">
        <input type="text" class="username-input" placeholder="è¯·è¾“å…¥ä½ çš„æ˜µç§°">
        <textarea class="message-input" placeholder="æƒ³è¯´çš„è¯ï¼ˆæ”¯æŒæ¢è¡Œå“¦~ï¼‰"></textarea>
        <button class="submit-btn">å‘é€ç•™è¨€</button>
    </div>

    <!-- ç•™è¨€åˆ—è¡¨åŒº -->
    <div class="message-list">
        <h2 class="list-title">æœ€æ–°ç•™è¨€</h2>
        <div class="loading-tip" id="loadingTip">åŠ è½½ä¸­... è¯·ç¨å€™</div>
        <div class="empty-tip" id="emptyTip" style="display: none;">
            <div class="empty-icon">ğŸ’¬</div>
            <p>è¿˜æ²¡æœ‰ç•™è¨€ï¼Œå¿«æ¥æŠ¢å æ²™å‘~</p>
        </div>
        <!-- ç•™è¨€å¡ç‰‡ä¼šé€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
    </div>

    <!-- åº•éƒ¨åŒæŒ‰é’®ï¼šé¦–é¡µ+ç•™è¨€æ¿ -->
    <div class="bottom-btn-container">
        <button class="bottom-btn home-btn" onclick="window.location.href='https://xiaomu1999f-cpu.github.io/xiaomu/index.html'">é¦–é¡µ</button>
        <button class="bottom-btn message-board-btn">ç•™è¨€æ¿</button>
    </div>

    <script>
        // #################### ä½ çš„ä¿¡æ¯å·²ä¿ç•™ ####################
        const GIST_ID = "7ea0532a9d2eb76a1a940c0256821bac"; 
        const GITHUB_TOKEN = "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"; 
        // ################################################################

        // DOMå…ƒç´ 
        const usernameInput = document.querySelector('.username-input');
        const messageInput = document.querySelector('.message-input');
        const submitBtn = document.querySelector('.submit-btn');
        const messageList = document.querySelector('.message-list');
        const loadingTip = document.querySelector('#loadingTip');
        const emptyTip = document.querySelector('#emptyTip');

        // åˆå§‹åŒ–ï¼šåŠ è½½ç•™è¨€
        async function init() {
            try {
                const messages = await fetchMessages();
                renderMessages(messages);
            } catch (err) {
                alert('åŠ è½½ç•™è¨€å¤±è´¥ï¼š' + err.message);
                loadingTip.textContent = 'åŠ è½½å¤±è´¥ï¼Œåˆ·æ–°è¯•è¯•~';
            }
        }

        // ä»Gistè¯»å–ç•™è¨€
        async function fetchMessages() {
            const url = `https://api.github.com/gists/${GIST_ID}`;
            const response = await fetch(url);
            
            if (!response.ok) throw new Error('Gistä¸å­˜åœ¨æˆ–è®¿é—®å¤±è´¥');
            
            const data = await response.json();
            const messageContent = data.files['messages.json'].content;
            return messageContent ? JSON.parse(messageContent) : [];
        }

        // æäº¤ç•™è¨€åˆ°Gist
        async function submitMessageToGist(newMessage) {
            // å…ˆè¯»å–ç°æœ‰ç•™è¨€
            const messages = await fetchMessages();
            // æ–°å¢ç•™è¨€æ”¾åœ¨æœ€å‰é¢
            messages.unshift(newMessage);
            // æ›´æ–°Gist
            const url = `https://api.github.com/gists/${GIST_ID}`;
            const response = await fetch(url, {
                method: 'PATCH',
                headers: {
                    'Authorization': `token ${GITHUB_TOKEN}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    files: {
                        'messages.json': {
                            content: JSON.stringify(messages, null, 2)
                        }
                    }
                })
            });

            if (!response.ok) throw new Error('æäº¤ç•™è¨€å¤±è´¥');
            return messages;
        }

        // æ¸²æŸ“ç•™è¨€åˆ—è¡¨
        function renderMessages(messages) {
            loadingTip.style.display = 'none';

            // æ¸…ç©ºç°æœ‰ç•™è¨€å¡ç‰‡
            const cards = messageList.querySelectorAll('.message-card');
            cards.forEach(card => card.remove());

            // æ˜¾ç¤ºç©ºæç¤º
            if (messages.length === 0) {
                emptyTip.style.display = 'block';
                return;
            }
            emptyTip.style.display = 'none';

            // æ¸²æŸ“æ¯ä¸ªç•™è¨€
            messages.forEach(message => {
                const card = document.createElement('div');
                card.className = 'message-card';
                card.innerHTML = `
                    <div class="card-header">
                        <span class="username">${escapeHtml(message.username)}</span>
                        <span class="time">${message.time}</span>
                    </div>
                    <div class="content">${escapeHtml(message.content)}</div>
                `;
                messageList.insertBefore(card, emptyTip);
            });
        }

        // é˜²æ­¢XSSæ”»å‡»
        function escapeHtml(str) {
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // æäº¤ç•™è¨€
        async function handleSubmit() {
            const username = usernameInput.value.trim();
            const content = messageInput.value.trim();

            // è¾“å…¥éªŒè¯
            if (!username) {
                alert('è¯·è¾“å…¥ä½ çš„æ˜µç§°å‘€~');
                return;
            }
            if (!content) {
                alert('æƒ³è¯´çš„è¯ä¸èƒ½ä¸ºç©ºå“¦~');
                return;
            }

            // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤æäº¤
            submitBtn.disabled = true;
            submitBtn.textContent = 'å‘é€ä¸­...';

            try {
                // æ„é€ ç•™è¨€å¯¹è±¡
                const newMessage = {
                    username,
                    content,
                    time: new Date().toLocaleString() // æœ¬åœ°æ—¶é—´
                };
                // æäº¤åˆ°Gistå¹¶é‡æ–°æ¸²æŸ“
                const updatedMessages = await submitMessageToGist(newMessage);
                renderMessages(updatedMessages);
                // æ¸…ç©ºè¾“å…¥æ¡†
                usernameInput.value = '';
                messageInput.value = '';
                alert('ç•™è¨€å‘é€æˆåŠŸï¼');
            } catch (err) {
                alert('å‘é€å¤±è´¥ï¼š' + err.message);
            } finally {
                // æ¢å¤æŒ‰é’®
                submitBtn.disabled = false;
                submitBtn.textContent = 'å‘é€ç•™è¨€';
            }
        }

        // ç»‘å®šäº‹ä»¶
        submitBtn.addEventListener('click', handleSubmit);
        // å›è½¦æäº¤ï¼ˆShift+Enteræ¢è¡Œï¼‰
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSubmit();
            }
        });

        // åˆå§‹åŒ–é¡µé¢
        init();
    </script>
</body>
</html>

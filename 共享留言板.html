<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç•™è¨€è¯„è®º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", "æ€æºé»‘ä½“", sans-serif;
        }

        html, body {
            height: 100%;
            background-color: #f5f7ff;
            overflow-x: hidden;
            padding-bottom: 70px; /* ç»™åº•éƒ¨æŒ‰é’®ç•™ç©ºé—´ */
        }

        /* é¡¶éƒ¨æ ‡é¢˜æ  */
        .top-bar {
            background: linear-gradient(135deg, #9370DB, #8A2BE2);
            padding: 18px 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(147, 112, 219, 0.3);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .title {
            font-size: 22px;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* ç•™è¨€è¾“å…¥åŒºï¼ˆé€‚é…è§¦æ§ï¼‰ */
        .input-area {
            padding: 20px;
            background-color: #fff;
            margin: 15px;
            border-radius: 12px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.05);
        }

        .username-input {
            width: 100%;
            height: 45px;
            padding: 0 15px;
            border: 2px solid #E6E6FA;
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 16px;
            color: #333;
        }

        .message-input {
            width: 100%;
            height: 120px;
            padding: 15px;
            border: 2px solid #E6E6FA;
            border-radius: 8px;
            resize: none;
            font-size: 16px;
            color: #333;
            line-height: 1.5;
        }

        .submit-btn {
            width: 100%;
            height: 50px;
            background: linear-gradient(135deg, #9370DB, #8A2BE2);
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            margin-top: 12px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(147, 112, 219, 0.3);
            transition: transform 0.2s;
        }

        .submit-btn:active {
            transform: scale(0.98);
        }

        /* ç•™è¨€åˆ—è¡¨åŒº */
        .message-list {
            padding: 0 20px 80px;
            flex: 1;
            overflow-y: auto;
        }

        .list-title {
            font-size: 18px;
            color: #666;
            margin: 15px 0;
            padding-left: 5px;
            border-left: 3px solid #9370DB;
        }

        /* ç•™è¨€å¡ç‰‡ */
        .message-card {
            background-color: #fff;
            padding: 18px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-left: 4px solid #9370DB;
            animation: fadeIn 0.5s ease; /* æ–°ç•™è¨€æ·¡å…¥åŠ¨ç”» */
        }

        /* æ–°ç•™è¨€æ·¡å…¥åŠ¨ç”» */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .username {
            font-size: 17px;
            font-weight: bold;
            color: #8A2BE2;
        }

        .time {
            font-size: 14px;
            color: #999;
        }

        .content {
            font-size: 16px;
            color: #333;
            line-height: 1.6;
            white-space: pre-wrap; /* ä¿ç•™æ¢è¡Œ */
        }

        /* ç©ºåˆ—è¡¨æç¤º */
        .empty-tip {
            text-align: center;
            padding: 50px 0;
            color: #999;
            font-size: 16px;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 15px;
            color: #E6E6FA;
        }

        /* åŠ è½½æç¤º */
        .loading-tip {
            text-align: center;
            padding: 30px 0;
            color: #999;
            font-size: 16px;
        }

        /* æ–°ç•™è¨€æç¤ºæ¡ */
        .new-message-tip {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #9370DB, #8A2BE2);
            color: #fff;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 14px;
            box-shadow: 0 3px 10px rgba(147, 112, 219, 0.3);
            z-index: 8;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .new-message-tip.show {
            opacity: 1;
        }

        /* åº•éƒ¨åŒæŒ‰é’®ï¼ˆåŒ¹é…ä½ æä¾›çš„å›¾ç‰‡é£æ ¼ï¼‰ */
        .bottom-btn-container {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 10px 20px;
            background-color: #fff;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 9;
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
        .bottom-btn {
            width: 48%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        /* é¦–é¡µæŒ‰é’®ï¼ˆå’Œä½ å›¾ç‰‡é‡Œçš„æ ·å¼ä¸€è‡´ï¼‰ */
        .home-btn {
            background: transparent;
            color: #8A2BE2; /* åŒ¹é…é¡µé¢ç´«è‰²é£æ ¼ */
        }
        /* ç•™è¨€æ¿æŒ‰é’®ï¼ˆå½“å‰é¡µæ ‡è¯†æ€ï¼‰ */
        .message-board-btn {
            background: linear-gradient(135deg, #9370DB, #8A2BE2);
            color: #fff;
            pointer-events: none; /* ç¦æ­¢ç‚¹å‡» */
        }
    </style>
    <!-- å¼•å…¥LeanCloud SDK -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>
</head>
<body>
    <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
    <div class="top-bar">
        <h1 class="title">âœ¨ ç•™è¨€è¯„è®º âœ¨</h1>
    </div>

    <!-- æ–°ç•™è¨€æç¤ºæ¡ï¼ˆé»˜è®¤éšè—ï¼‰ -->
    <div class="new-message-tip" id="newMessageTip">æœ‰æ–°çš„ç•™è¨€å•¦ï½</div>

    <!-- ç•™è¨€è¾“å…¥åŒº -->
    <div class="input-area">
        <input type="text" class="username-input" placeholder="è¯·è¾“å…¥ä½ çš„æ˜µç§°">
        <textarea class="message-input" placeholder="æƒ³è¯´çš„è¯ï¼ˆæ”¯æŒæ¢è¡Œå“¦~ï¼‰"></textarea>
        <button class="submit-btn">å‘é€ç•™è¨€</button>
    </div>

    <!-- ç•™è¨€åˆ—è¡¨åŒº -->
    <div class="message-list">
        <h2 class="list-title">æœ€æ–°ç•™è¨€</h2>
        <div class="loading-tip" id="loadingTip">åŠ è½½ä¸­... è¯·ç¨å€™</div>
        <div class="empty-tip" id="emptyTip" style="display: none;">
            <div class="empty-icon">ğŸ’¬</div>
            <p>è¿˜æ²¡æœ‰ç•™è¨€ï¼Œå¿«æ¥æŠ¢å æ²™å‘~</p>
        </div>
        <!-- ç•™è¨€å¡ç‰‡ä¼šé€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
    </div>

    <!-- åº•éƒ¨åŒæŒ‰é’®ï¼šé¦–é¡µ+ç•™è¨€æ¿ -->
    <div class="bottom-btn-container">
        <button class="bottom-btn home-btn" onclick="window.location.href='https://xiaomu1999f-cpu.github.io/xiaomu/index.html'">é¦–é¡µ</button>
        <button class="bottom-btn message-board-btn">ç•™è¨€æ¿</button>
    </div>

    <script>
        // æœ€ç»ˆç‰ˆLeanCloudé…ç½®ï¼ˆ100%åŒ¹é…ä½ çš„å›½é™…ç‰ˆåº”ç”¨ï¼‰
        AV.init({
            appId: "axRSxsxwONJG6tu4LTjWtzSA-MdYXbMMI", // ä½ çš„æ­£ç¡®APP_ID
            appKey: "ezPH28np7U6A2ZqYTrrfywrc", // æ­£ç¡®APP_KEY
            serverURLs: "https://axrsxsxw.api.lncldglobal.com" // æ­£ç¡®ä¸“å±æœåŠ¡å™¨åœ°å€
        });
        const Message = AV.Object.extend('Message');

        // DOMå…ƒç´ 
        const usernameInput = document.querySelector('.username-input');
        const messageInput = document.querySelector('.message-input');
        const submitBtn = document.querySelector('.submit-btn');
        const messageList = document.querySelector('.message-list');
        const loadingTip = document.querySelector('#loadingTip');
        const emptyTip = document.querySelector('#emptyTip');
        const newMessageTip = document.querySelector('#newMessageTip');

        // å­˜å‚¨å½“å‰ç•™è¨€æ•°é‡ï¼ˆç”¨äºåˆ¤æ–­æ˜¯å¦æœ‰æ–°ç•™è¨€ï¼‰
        let currentMessageCount = 0;

        // åˆå§‹åŒ–ï¼šåŠ è½½ç•™è¨€+å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
        async function init() {
            try {
                const messages = await fetchMessages();
                currentMessageCount = messages.length; // è®°å½•åˆå§‹ç•™è¨€æ•°
                renderMessages(messages);
                startAutoRefresh(); // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
            } catch (err) {
                alert('åŠ è½½ç•™è¨€å¤±è´¥ï¼š' + err.message);
                loadingTip.textContent = 'åŠ è½½å¤±è´¥ï¼Œåˆ·æ–°è¯•è¯•~';
            }
        }

        // ä»LeanCloudè¯»å–ç•™è¨€
        async function fetchMessages() {
            const query = new AV.Query(Message);
            query.descending('createdAt'); // æŒ‰æ—¶é—´å€’åºï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
            const messageObjects = await query.find();
            // è½¬æ¢ä¸ºæ™®é€šå¯¹è±¡ä¾¿äºæ¸²æŸ“
            return messageObjects.map(msg => ({
                id: msg.id, // ç”¨LeanCloudçš„å”¯ä¸€IDæ ‡è¯†ç•™è¨€ï¼Œé¿å…é‡å¤
                username: msg.get('username'),
                content: msg.get('content'),
                time: msg.createdAt.toLocaleString()
            }));
        }

        // æäº¤ç•™è¨€åˆ°LeanCloud
        async function submitMessageToCloud(newMessage) {
            const message = new Message();
            message.set('username', newMessage.username);
            message.set('content', newMessage.content);
            await message.save();
            // ä¿å­˜åè¿”å›æœ€æ–°ç•™è¨€åˆ—è¡¨
            return fetchMessages();
        }

        // æ¸²æŸ“ç•™è¨€åˆ—è¡¨
        function renderMessages(messages) {
            loadingTip.style.display = 'none';

            // æ¸…ç©ºç°æœ‰ç•™è¨€å¡ç‰‡ï¼ˆé™¤äº†æ ‡é¢˜ã€åŠ è½½æç¤ºã€ç©ºæç¤ºï¼‰
            const cards = messageList.querySelectorAll('.message-card');
            cards.forEach(card => card.remove());

            // æ˜¾ç¤ºç©ºæç¤º
            if (messages.length === 0) {
                emptyTip.style.display = 'block';
                return;
            }
            emptyTip.style.display = 'none';

            // æ¸²æŸ“æ¯ä¸ªç•™è¨€
            messages.forEach(message => {
                const card = document.createElement('div');
                card.className = 'message-card';
                card.dataset.id = message.id; // å­˜å‚¨ç•™è¨€ID
                card.innerHTML = `
                    <div class="card-header">
                        <span class="username">${escapeHtml(message.username)}</span>
                        <span class="time">${message.time}</span>
                    </div>
                    <div class="content">${escapeHtml(message.content)}</div>
                `;
                messageList.insertBefore(card, emptyTip);
            });
        }

        // è‡ªåŠ¨åˆ·æ–°æœ€æ–°ç•™è¨€ï¼ˆ30ç§’ä¸€æ¬¡ï¼‰
        function startAutoRefresh() {
            setInterval(async () => {
                try {
                    const latestMessages = await fetchMessages();
                    const newCount = latestMessages.length;

                    // åˆ¤æ–­æ˜¯å¦æœ‰æ–°ç•™è¨€ï¼ˆæ–°æ•°é‡ > å½“å‰æ•°é‡ï¼‰
                    if (newCount > currentMessageCount) {
                        const newMessages = latestMessages.slice(0, newCount - currentMessageCount); // åªå–æ–°å¢çš„ç•™è¨€
                        currentMessageCount = newCount; // æ›´æ–°å½“å‰ç•™è¨€æ•°

                        // æ˜¾ç¤ºæ–°ç•™è¨€æç¤ºï¼ˆ3ç§’åè‡ªåŠ¨éšè—ï¼‰
                        newMessageTip.classList.add('show');
                        setTimeout(() => newMessageTip.classList.remove('show'), 3000);

                        // æŠŠæ–°ç•™è¨€æ’å…¥åˆ°åˆ—è¡¨æœ€å‰é¢ï¼ˆå¸¦åŠ¨ç”»ï¼‰
                        newMessages.forEach(msg => {
                            const card = document.createElement('div');
                            card.className = 'message-card';
                            card.dataset.id = msg.id;
                            card.innerHTML = `
                                <div class="card-header">
                                    <span class="username">${escapeHtml(msg.username)}</span>
                                    <span class="time">${msg.time}</span>
                                </div>
                                <div class="content">${escapeHtml(msg.content)}</div>
                            `;
                            // æ’å…¥åˆ°åˆ—è¡¨é¡¶éƒ¨ï¼ˆæœ€æ–°ç•™è¨€åœ¨æœ€å‰é¢ï¼‰
                            messageList.insertBefore(card, messageList.querySelector('.list-title').nextSibling);
                        });
                    }
                } catch (err) {
                    console.log('è‡ªåŠ¨åˆ·æ–°å¤±è´¥ï¼š', err); // ä¸å¼¹çª—æ‰“æ‰°ç”¨æˆ·ï¼Œåªåœ¨æ§åˆ¶å°æ‰“å°
                }
            }, 30000); // 30ç§’åˆ·æ–°ä¸€æ¬¡ï¼ˆå¯ä¿®æ”¹æ•°å­—è°ƒæ•´é—´éš”ï¼Œå•ä½ï¼šæ¯«ç§’ï¼‰
        }

        // é˜²æ­¢XSSæ”»å‡»
        function escapeHtml(str) {
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // æäº¤ç•™è¨€
        async function handleSubmit() {
            const username = usernameInput.value.trim();
            const content = messageInput.value.trim();

            // è¾“å…¥éªŒè¯
            if (!username) {
                alert('è¯·è¾“å…¥ä½ çš„æ˜µç§°å‘€~');
                return;
            }
            if (!content) {
                alert('æƒ³è¯´çš„è¯ä¸èƒ½ä¸ºç©ºå“¦~');
                return;
            }

            // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤æäº¤
            submitBtn.disabled = true;
            submitBtn.textContent = 'å‘é€ä¸­...';

            try {
                // æ„é€ ç•™è¨€å¯¹è±¡
                const newMessage = {
                    username,
                    content,
                    time: new Date().toLocaleString()
                };
                // æäº¤åˆ°LeanCloudå¹¶é‡æ–°æ¸²æŸ“
                const updatedMessages = await submitMessageToCloud(newMessage);
                currentMessageCount = updatedMessages.length; // æ›´æ–°ç•™è¨€æ•°
                renderMessages(updatedMessages);
                // æ¸…ç©ºè¾“å…¥æ¡†
                usernameInput.value = '';
                messageInput.value = '';
                alert('ç•™è¨€å‘é€æˆåŠŸï¼');
            } catch (err) {
                alert('å‘é€å¤±è´¥ï¼š' + err.message);
            } finally {
                // æ¢å¤æŒ‰é’®
                submitBtn.disabled = false;
                submitBtn.textContent = 'å‘é€ç•™è¨€';
            }
        }

        // ç»‘å®šäº‹ä»¶
        submitBtn.addEventListener('click', handleSubmit);
        // å›è½¦æäº¤ï¼ˆShift+Enteræ¢è¡Œï¼‰
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSubmit();
            }
        });

        // åˆå§‹åŒ–é¡µé¢
        init();
    </script>
</body>
</html>
